<!DOCTYPE html>
<html lang="en">

<head>
    <title>dc.js - Toulousains morts pour la France en 1914-1918</title>
    <meta charset="UTF-8">
<script   src="https://code.jquery.com/jquery-2.2.1.min.js"   integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00="   crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.2.0/crossfilter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-beta.26/dc.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-beta.26/dc.min.css" />
</head>
  
  <style>
	body{
      background-color: #dddddd;
    }

    svg {
	  background-color: #dddddd;
        font-family: 'Lato';
     }
	.row {
	font: 12px sans-serif;
	color : #f03b20;
	} 
	
	.dc-chart g.state path {
    stroke: #aaa;
}
  </style>
<body>
    <div class='container' style='font: 9px sans-serif;'>
        <div class='row' style='font: 12px sans-serif; color :black'>
            <h3>Toulousains morts pour la France en 1914-1918 </h3>
            <p><strong>Explorateur de données </strong>réalisé à partir du 
                <a href='https://data.toulouse-metropole.fr/explore/dataset/toulousains-morts-pour-la-france-1914-1919/'> jeu de données </a>  disponible sur le site open data de Toulouse Métropole et de  <a href='http://professionnels.ign.fr/geofla#tab-3'> données géographiques </a> transformées dans un format json.</p>
            <p>Ce jeu de données contient la liste de <strong>3893</strong> Toulousains morts pour la France lors de la guerre 14-18 : Nom, Prénoms, Date de naissance, Ville de naissance, Département de naissance, Pays, Régiment, Grade, Date du décès, Département de décès, Lieu du décès, Pays de décès.</p>
            <p><strong>Comment fonctionne cet explorateur :</strong>
            </p>
            <p>Les 7 graphiques et le tableau de données sont liés dynamiquement entre eux. L’exploration s’effectue avec l’aide de la souri de l’ordinateur directement sur les graphiques : </p>
            <ul>
                <li>En cliquant sur une ou plusieurs zones des cartes, les données correspondantes sont sélectionnées et les autres graphiques et le tableau de données sont instantanément mis à jour </li>
                <li>En cliquant et en déplaçant la souri sur les histogrammes, un selecteur apparait qui permet de sélectionner une partie des données. De la même manière, les autres graphiques et le tableau de données sont instantanément mis à jour.</li>
            </ul>
            <p>Developpé par<a href='mailto:contact@datasens.fr'> Alain Ottenheimer </a>- DataSens - 2016 </p>
            <p></p>
			<p></p>
        </div>
        <div class='row' >
		    <div class='col-md-3' id='graph1'>
                #1 Pays de naissance
                <a class="reset" href="javascript:carteNMonde.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | filter: <span class="filter"></span></span>

                <div class="clearfix"></div>
            </div>
			<div class='col-md-3 col-md-offset-0' id='graph2'>
                #2 Dpt de naissance
                <a class="reset" href="javascript:carteN.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | filtre: <span class="filter"></span></span>
                <div class="clearfix"></div>
            </div>
			<div class='col-md-3' id='graph3'>
               #3 Pays de décès
                <a class="reset" href="javascript:carteDMonde.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | filter: <span class="filter"></span></span>

                <div class="clearfix"></div>
            </div>
            <div class='col-md-3' id='graph4'>
                #4 Dpt de décès
                <a class="reset" href="javascript:carteD.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | Filtre: <span class="filter"></span></span>
                <div class="clearfix"></div>
            </div>
        </div>
		<div class='col-md-5'>
		 <div class='row' >
		    <div class='col-md-12' id='graph5'>
                #5 Décès par mois
                <a class="reset" href="javascript:NbMortMoisChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | Filtre: <span class="filter"></span></span>
                <div class="clearfix"></div>
            </div>
		</div>	
		 <div class='row' >
		    <div class='col-md-12' id='graph6'>
                #6 Age moyen au décès
                <a class="reset" href="javascript:moyChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <span class="reset" style="display: none;"> | Filtre: <span class="filter"></span></span>
	            <div class="clearfix"></div>
            </div>
		</div>		
		 </div>		
            <div class='col-md-7' id='graph7'>
			 <div class='row' >
                #7 Décès par age</strong>
                <a class="reset" href="javascript:NbMortAgeChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			    <span class="reset" style="display: none;"> | filter: <span class="filter"></span></span>
                <div class="clearfix"></div>
            </div>
          </div>
		
        <div class='row'>
		<div class='col-md-12'>
            <div class="dc-data-count" style='font: 12px sans-serif;'>
             
           </div>
				
			</div>
            <div class='col-md-12' style='font: 10px sans-serif; color: black'>
                <table class="table table-bordered table-striped" id="table-graph">
                    <thead>
                        <tr class='header' >
                            <th> Nom </th>
                            <th> Prénoms </th>
                            <th> Age </th>
                            <th> Grade </th>
                            <th> Régiment </th>
                            <th> Date du décès </th>
                            <th> Lieu du décès </th>
							<th> Pays du décès </th>
                            <th> N° dpt décès </th>
							<th> Carte </th>
                            <th> Lieu de naissance</th>
							<th> Pays de naissance</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var carteNMonde = dc.geoChoroplethChart("#graph1");
		var carteN = dc.geoChoroplethChart("#graph2");
		var carteDMonde = dc.geoChoroplethChart("#graph3");
        var carteD = dc.geoChoroplethChart("#graph4");	   
        var NbMortMoisChart = dc.barChart("#graph5");
		var moyChart = dc.barChart("#graph6");
		//var moyChart = dc.lineChart("#graph6");
		var NbMortAgeChart = dc.barChart("#graph7");
		
        var dataTable = dc.dataTable("#table-graph,.dc-data-table");
        var count = dc.dataCount('.dc-data-count');
		var size = 20;

        d3.csv("data/toulousains-morts-pour-la-france-1914-1919W.csv", function (csv) {
		    var dtgFormat1 = d3.time.format("%Y-%m-%d");
            var dtgFormat2 = d3.time.format("%d/%m/%Y");
            var numberFormat = d3.format(".0f");
            var dtgFormat3 = d3.time.format("%Y/%m");
            var dtgFormat4 = d3.time.format("%b %Y");

            function _calculateAge(dDeces, dNaissance) {
                var ageDifMs = dDeces.getTime() - dNaissance.getTime();
			    var ageDate = new Date(ageDifMs); 
			   return Math.abs(ageDate.getUTCFullYear()-1970);
            }

            csv.forEach(function (d) {
                d.dateNaissance = dtgFormat1.parse(d.Date_de_naissance);
                d.dateDeces = dtgFormat2.parse(d.Date_du_décès);
			    d.dateDecesM = d3.time.month(d.dateDeces);
                d.dptNaissance = d.Département_de_naissance;
                d.dptDeces = d.Département_de_décès;
                d.age = _calculateAge(d.dateDeces, d.dateNaissance);
            });

            var data = crossfilter(csv);
            var all = data.groupAll()
            var dptN = data.dimension(function (d) {
                return d["dptNaissance"];
            });
			var paysN = data.dimension(function (d) {
                return d["Pays"];
            });
			var paysD = data.dimension(function (d) {
                return d["Pays_de_décès"];
            });
			
            var dptD = data.dimension(function (d) {
                return d["dptDeces"];
            });
           
            var anneeDecesM = data.dimension(function (d) {
                return d["dateDecesM"];
            });
            var ageDeces = data.dimension(function (d) {
                return d["age"];
            });
            var NombredptNSum = dptN.group().reduceCount(); 
			var NombrepaysDSum = paysD.group(); // reduceCount() pas necessaire!
			var NombrepaysNSum = paysN.group();
            var NombredptDSum = dptD.group();
            var ageDecesGroup = ageDeces.group();
			console.log(ageDecesGroup.top(5)) ;
			
			var anneeDecesMGroup = anneeDecesM.group().reduce(
            //callback for when data is added to the current filter results 
            function (p, v) {
                ++p.count;
                p.sum += v['age'];
				p.moy = Math.round(p.sum / p.count);
                return p;
            },
            // callback for when data is removed from the current filter results 
            function (p, v) {
				--p.count;
                p.sum -= v['age'];
				p.moy = Math.round(p.sum / p.count);
			   return p;
            },
            // initialize p 
            function () {
                return {
                    count: 0,
                   	sum: 0,
                    moy: 0,
                };
            });
			
			//console.log(ageDecesGroup.top(10));
			
//#1 carte des lieux de décès reste du monde 
	d3.json("data/world.json", function (carteMonde) {
			       carteNMonde.width(300)
                    .height(200)
                    .dimension(paysN)
                    .group(NombrepaysNSum)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0,120])
                    .colorCalculator(function (d) {
                        return d ? carteNMonde.colors()(d) : '#ddd';
                    })
                    .projection(d3.geo.mercator()
                        .center([0, 0])
                        .translate([115,110])
                        .scale(85))
                    .overlayGeoJson(carteMonde.features, "state", function (d) {
                        return d.properties.sovereignt;
                    })
                    .title(function (d) {
                        return "Pays : " + d.key + "\nNb de Naissance : " + numberFormat(d.value ? d.value : 0);
                    });
                carteNMonde.render();
            });
			
			
//#2 carte des lieux de naissance 
           d3.json("data/departements.json", function (dptJson) {
			       carteN.width(250)
                    .height(250)
                    .dimension(dptN)
                    .group(NombredptNSum)
                    .colors(d3.scale.sqrt(),quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0,450])
                    .colorCalculator(function (d) {
                        return d ? carteN.colors()(d) : '#ddd';
                    })
                    .projection(d3.geo.mercator()
                        .center([-6,52])
                        .translate([0,0])
                        .scale(800))
                    .overlayGeoJson(dptJson.features, "state", function (d) {
                        return d.properties.CODE_DEPT;
                    })
                    .title(function (d) {
                        return "N°dpt : " + d.key + "\nNb de Naissances : " + numberFormat(d.value ? d.value : 0);
                    })
                   .render();
            });
			
//#3 carte des lieux de décès reste du monde 
	d3.json("data/world.json", function (carteMonde) {
			       carteDMonde.width(300)
                    .height(200)
                    .dimension(paysD)
                    .group(NombrepaysDSum)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0,120])
                    .colorCalculator(function (d) {
                        return d ? carteDMonde.colors()(d) : '#ddd';
                    })
                    .projection(d3.geo.mercator()
                        .center([0, 0])
                        .translate([80,300])
                        .scale(250))
                    .overlayGeoJson(carteMonde.features, "state", function (d) {
                        return d.properties.sovereignt;
                    })
                    .title(function (d) {
                        return "Pays : " + d.key + "\nNb de décès : " + numberFormat(d.value ? d.value : 0);
                    });
                carteDMonde.render();
            });			
//#4 carte des lieux de décès en France			
		 d3.json("data/departements.json", function (dptJson) {
				carteD.width(250)
                    .height(250)
                    .dimension(dptD)
                    .group(NombredptDSum)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 450])
                    .colorCalculator(function (d) {
                        return d ? carteD.colors()(d) : '#ddd';
                    })
                    .projection(d3.geo.mercator()
                        .center([-6, 52])
                        .translate([0, 0])
                        .scale(800))
                    .overlayGeoJson(dptJson.features, "state", function (d) {
                        return d.properties.CODE_DEPT;
                    })
                    .title(function (d) {
                        return "N°dpt : " + d.key + "\nNb de décès : " + numberFormat(d.value ? d.value : 0);
                    });
                carteD.render();
            });

//#5 Diagramme en barres des décès par mois       			
            NbMortMoisChart.width(510)
                .height(200)
                .margins({
                    top: 30,
                    right: 50,
                    bottom: 60,
                    left: 40
                })
                .dimension(anneeDecesM)
                .group(anneeDecesMGroup)
				.valueAccessor(function (d) {
                return d.value.count
                })
                 .brushOn(true)
				.y(d3.scale.linear().domain([0, 350]))
                .x(d3.time.scale().domain([new Date(dtgFormat3.parse("1914/06")), new Date(dtgFormat3.parse("1919/12"))]))
                .elasticY(true)
                .renderLabel(false)
                .yAxisLabel("Nombre")
                .title(function (d) {
                    return dtgFormat4(d.key) + '\nDécès : ' + d.value.count
                })
                .renderHorizontalGridLines(true);
            NbMortMoisChart.yAxis().ticks(5).tickFormat(function (s) {
                return s + "";
            });
            NbMortMoisChart.xAxis().ticks(25).tickFormat(d3.time.format("%b-%Y"));
            NbMortMoisChart.renderlet(function (NbMortMoisChart) {
                NbMortMoisChart.selectAll('g.x text')
                    .attr('transform', 'translate(-22,15) rotate(315) ');
            })
            NbMortMoisChart.render();

//#6 Diagramme en ligne age moyen des décès  			
  moyChart.width(510)
                .height(150)
                .margins({
                    top: 30,
                    right: 50,
                    bottom: 60,
                    left: 40
                })
                .valueAccessor(function (d) {
					return d.value.moy
				})
                .brushOn(false)
				.y(d3.scale.linear().domain([0, 40]))
                .x(d3.time.scale().domain([new Date(dtgFormat3.parse("1914/06")), new Date(dtgFormat3.parse("1919/12"))]))
			    .renderLabel(false)
                .yAxisLabel("Age") 
				.dimension(anneeDecesM)
                .group(anneeDecesMGroup)
                .title(function (d) {
                   return dtgFormat4(d.key) + '\nMoyenne d\'age décès : ' + d.value.moy +'\nNombre : '+ d.value.count
                })
                .renderHorizontalGridLines(true);
			moyChart.yAxis().ticks(5).tickFormat(function (s) {return s + ""; })
			moyChart.xAxis().ticks(25).tickFormat(d3.time.format("%b-%Y"))
			moyChart.renderlet(function (moyChart) {
				 moyChart.selectAll('g.x text').attr('transform', 'translate(-22,15) rotate(315) ')	})
			moyChart.render();			
			
 //#7 Diagramme en barres des décès par age  
            NbMortAgeChart.width(700)
                .height(350)
                .margins({
                    top: 10,
                    right: 50,
                    bottom: 50,
                    left: 40
                })
                .dimension(ageDeces)
                .group(ageDecesGroup)
				.brushOn(true)
                .y(d3.scale.linear().domain([0, 450]))
                .elasticY(true)
                .renderLabel(true)
                .gap(1)
                .round(dc.round.floor)
                .alwaysUseRounding(true)
                .x(d3.scale.linear().domain([15, 65]))
                .yAxisLabel("Nombre")
                .xAxisLabel("Age")
                .renderHorizontalGridLines(true);
            NbMortAgeChart.yAxis().tickFormat(function (s) {
                return s + "";
            });
            NbMortAgeChart.xAxis().ticks(8).tickFormat(d3.format("0f"));
            NbMortAgeChart.render();
			
			
// Compteur			
            count
                .dimension(data)
                .group(all)
                .html({
                    some: '<strong>%filter-count</strong> sélectionnés sur <strong>%total-count</strong> enregistrements  |' +
                        '<a href=\'javascript: dataTable.size(Infinity).render(); dc.renderAll();\'\'> Voir tous les enregistrements</a>'+ ' | '+'<a href=\'javascript: dc.filterAll();dataTable.size(size).render(); dc.redrawAll();\'\'>Reset All</a>',
                    all: 'Tous les enregistrements sélectionnés. Cliquer sur les graphes pour appliquer les filtres. | ' + '<a href=\'javascript: dataTable.size(Infinity).render(); dc.renderAll();\'\'> Voir tous les enregistrements</a>'+ ' | '+'<a href=\'javascript: dc.filterAll();dataTable.size(size).render(); dc.redrawAll();\'\'>Reset All</a>'
                })
                .render(); 
			
//Table 
            dataTable.width(960).height(800)
                .dimension(dptN)
                .group(function (d) {return d;               
                })
                .size(size)
                .columns([
      function (d) {
                        return d.Nom;
       },
      function (d) {
                        return d.Prénoms;
       },
      function (d) {
                        return d.age;
       },
    function (d) {
                        return d.Grade
    },
      function (d) {
                        return d.Régiment;
       },
    function (d) {
                        return d.Date_du_décès;
       },
      function (d) {
                        return d.Lieu_du_décès;
       },
	function (d) {
                        return d.Pays_de_décès;
       },
       function (d) {
                        return d.dptDeces;
       },
	   function (d) {
                        return '<a href=\"http://maps.google.com/maps?z=1&t=m&q=loc:' + d.Lieu_du_décès + ' '+ d.Pays_de_décès + "\" target=\"_blank\">carte</a>"
                    },
     function (d) {
                        return d.Ville_de_naissance;
       },
	     function (d) {
                        return d.Pays;
       },
    ])
                .sortBy(function (d) {
                    return d.Nom;
                })
                .order(d3.descending)
                .on('renderlet', function (table) {
                    table.select('tr.dc-table-group').remove()
                })
                .render();
        });
	
    </script>
</body>

</html>